var gallery_editor = (function($) {
    
    return {
        
        init: function() {
            
            if ($('#gallery-drop-bar').length) {
                //droppable section for gallery images
                filepicker.setKey('<%= Settings.filepicker.api_key %>');
                filepicker.makeDropPane($('#gallery-drop-bar'), {
                    multiple: true,
                    path: 'images/',
                    dragEnter: function() {
                        $("#gallery-drop .title").text("Drop to Upload");
                    },
                    dragLeave: function() {
                        $("#gallery-drop .title").text("Drop Images Here");
                    },
                    onSuccess: function(InkBlobs) {
                        for (var i = 0; i < InkBlobs.length; i++) {
                            gallery_editor.addImage(InkBlobs[i].url);
                        }
                        $("#gallery-drop .title").text("Drag more Images Here to Add to the Gallery");
                    },
                    onProgress: function(percentage) {
                        $("#gallery-drop .title").text("Uploading (" + Math.round(percentage) + "%)");
                    }
                });
            
                //make all images sortable
                $('#gallery').sortable(
                    {
                        update: function(){
                            $.post(
                                $(this).data('update-url'), 
                                $(this).sortable('serialize')
                            );
                        }
                    }
                );
                
                //hover for overlay
                $("#gallery").on('mouseenter mouseleave', '.image-container', function(event){
                    if(event.type == "mouseenter") {
                        $(this).children('.overlay').show();
                    } else {
                        $(this).children('.overlay').hide();
                    }
                });
                
                //remove click for each image
                $('#gallery').on('click', '.overlay .buttons .remove', function(event){
                    event.preventDefault();
                    
                    $('#image_' + $(this).data('gallery-image-id')).remove();
                    
                    $.post(
                        '/admin/galleries/remove_image',
                        {
                            id: $(this).data('gallery-image-id')
                        }
                    );
                });
                
                $('#gallery').on('click', '.buttons .edit', function(){
                    $('.image-container .image').removeClass('active');
                    $('#gallery-drop-bar').hide();
                    $(this).parent().parent().parent().find('.image').addClass('active');
                    $.paneslide({ href: $(this).data('pane'), maincontainer: '#gallery, #bottom-bar .buttons' });
                });
                
                // add the image previous and next handlers
                $(document).on('click', '#image-info-previous', function(){
                    alert($('.image-container .image.active').parent().data('widget-id'));
                });
                
            }
        }, 
        
        addImage: function(url) {
            //get the values
            var image_url = url;
            
            //post to the galleries addImage method
            $("#gallery-drop .title").text("Creating Image");
            $.post(
                '/admin/galleries/add_image',
                {
                    gallery_id: $('#gallery').data('id'),
                    image_url:  image_url
                },
                function(data) {
                    //the Image object has now been created
                    //now add it to the gallery
                    $.post(
                        '/admin/galleries/select_image',
                        {
                            gallery_id: $('#gallery').data('id'),
                            image_id: data,
                            position: $('#gallery .widget').length
                        }
                    );
                }
            );
        }
        
        
    };
})(jQuery);

jQuery(document).ready(function($) {
    gallery_editor.init();
});